AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'Root stack for creating a passwordless login system using Google OAuth
  2.0 and Cognito. This stack also launches the core infrastructure for real-time
  chat using a single-table DynamoDB design optimized for scale. It also deploys observability
  Lambdas (Vault/Chatwoot/SES).

  '
Parameters:
  Stage:
    Type: String
    Default: dev
    Description: 'The deployment stage name, such as dev, qa, or prod.

      This value is passed to all nested stacks to help suffix or tag resources.

      '
  DeploymentBucket:
    Type: String
    Description: 'The name of the S3 bucket where your packaged CloudFormation templates
      are stored.

      The nested stacks are pulled from this bucket via their TemplateURL.

      '
  GoogleClientId:
    Type: String
    Description: 'The OAuth 2.0 client ID for your Google application.

      Used to enable Google Sign-In through Cognito.

      '
  GoogleClientSecret:
    Type: String
    Description: 'The OAuth 2.0 client secret for your Google application.

      Used with Cognito for secure token exchange.

      '
Resources:
  CoreInfraStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::Sub: https://${DeploymentBucket}.s3.${AWS::Region}.amazonaws.com/services/core-infra/core-infra.yaml
      Parameters:
        Stage:
          Ref: Stage
    Metadata:
      SamResourceId: CoreInfraStack
  LambdaStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::Sub: https://${DeploymentBucket}.s3.${AWS::Region}.amazonaws.com/services/lambdas/nested-lambdas-stack.yaml
      Parameters:
        Stage:
          Ref: Stage
        ChatAppTableName:
          Fn::GetAtt:
          - CoreInfraStack
          - Outputs.ChatAppTableName
        ChatAppTableArn:
          Fn::GetAtt:
          - CoreInfraStack
          - Outputs.ChatAppTableArn
    Metadata:
      SamResourceId: LambdaStack
  CognitoGoogleAuthStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::Sub: https://${DeploymentBucket}.s3.${AWS::Region}.amazonaws.com/services/cognito/nested-cognito-google-auth-stack.yaml
      Parameters:
        Stage:
          Ref: Stage
        GoogleClientId:
          Ref: GoogleClientId
        GoogleClientSecret:
          Ref: GoogleClientSecret
        PostConfirmationLambdaArn:
          Fn::GetAtt:
          - LambdaStack
          - Outputs.PostConfirmationLambdaArn
    Metadata:
      SamResourceId: CognitoGoogleAuthStack
Outputs:
  CognitoNestedStackId:
    Description: 'Logical ID of the Cognito Google OAuth nested stack.

      Can be used to trace and debug the auth layer separately.

      '
    Value:
      Ref: CognitoGoogleAuthStack
  CoreInfraNestedStackId:
    Description: 'Logical ID of the Core Infrastructure nested stack.

      Useful for tracing database infrastructure and state.

      '
    Value:
      Ref: CoreInfraStack
  LambdaStack:
    Description: 'Logical ID of the Observability Lambda nested stack.

      Provides insight into the health and monitoring setup.

      '
    Value:
      Ref: LambdaStack
