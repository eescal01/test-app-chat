AWSTemplateFormatVersion: '2010-09-09'
Description: 'Single-table DynamoDB design to support real-time messaging at scale
  across thousands of users and conversations. Enables efficient queries for user
  profiles, messages, and chat metadata using GSIs.

  '
Parameters:
  Stage:
    Type: String
    Description: Deployment stage for environment separation (e.g. dev, qa, prod)
Resources:
  ChatAppTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: chat-app-table-${Stage}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: PK
        AttributeType: S
      - AttributeName: SK
        AttributeType: S
      - AttributeName: GSI1PK
        AttributeType: S
      - AttributeName: GSI1SK
        AttributeType: S
      - AttributeName: Type
        AttributeType: S
      - AttributeName: name
        AttributeType: S
      - AttributeName: lastUpdated
        AttributeType: S
      KeySchema:
      - AttributeName: PK
        KeyType: HASH
      - AttributeName: SK
        KeyType: RANGE
      GlobalSecondaryIndexes:
      - IndexName: GSI1
        KeySchema:
        - AttributeName: GSI1PK
          KeyType: HASH
        - AttributeName: GSI1SK
          KeyType: RANGE
        Projection:
          ProjectionType: ALL
      - IndexName: TypeNameIndex
        KeySchema:
        - AttributeName: Type
          KeyType: HASH
        - AttributeName: name
          KeyType: RANGE
        Projection:
          ProjectionType: ALL
      - IndexName: ChatMessageIndex
        KeySchema:
        - AttributeName: GSI1PK
          KeyType: HASH
        - AttributeName: lastUpdated
          KeyType: RANGE
        Projection:
          ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      Tags:
      - Key: Project
        Value: ScalableChatApp
      - Key: Environment
        Value:
          Ref: Stage
    Metadata:
      SamResourceId: ChatAppTable
Outputs:
  ChatAppTableName:
    Description: Name of the chat DynamoDB table
    Value:
      Ref: ChatAppTable
  ChatAppTableArn:
    Description: ARN of the chat DynamoDB table
    Value:
      Fn::GetAtt:
      - ChatAppTable
      - Arn
